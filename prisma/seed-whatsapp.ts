import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function seedWhatsApp() {
  console.log('üå± Ajout des templates WhatsApp par d√©faut...');

  // Templates par d√©faut
  const templates = [
    {
      name: 'Rappel RDV 24h',
      category: 'reminder',
      content: 'Bonjour {name} üëã\n\nPetit rappel pour votre rendez-vous demain √† {time} pour {service}.\n\nüìç LAIA SKIN Institut\nüìû En cas d\'emp√™chement : 01 23 45 67 89\n\n√Ä demain ! üíï',
      variables: JSON.stringify(['name', 'time', 'service']),
      active: true
    },
    {
      name: 'Rappel RDV 48h',
      category: 'reminder',
      content: 'Bonjour {name} üëã\n\nVotre rendez-vous approche !\nüìÖ {date}\nüïê {time}\n‚ú® {service}\n\nH√¢te de vous retrouver !\nL\'√©quipe LAIA SKIN üíï',
      variables: JSON.stringify(['name', 'date', 'time', 'service']),
      active: true
    },
    {
      name: 'Anniversaire',
      category: 'birthday',
      content: 'üéÇ Joyeux anniversaire {name} ! üéâ\n\nPour c√©l√©brer ce jour sp√©cial, nous vous offrons -30% sur le soin de votre choix !\n\nüéÅ Offre valable tout le mois\nüìû R√©servez vite : 01 23 45 67 89\n\nBelle journ√©e ! üíï',
      variables: JSON.stringify(['name']),
      active: true
    },
    {
      name: 'Suivi post-soin',
      category: 'followup',
      content: 'Bonjour {name} üëã\n\nComment vous sentez-vous apr√®s votre {service} d\'hier ?\n\nüíß N\'oubliez pas de bien vous hydrater\n‚òÄÔ∏è Prot√©gez votre peau du soleil\n‚ú® Suivez nos conseils personnalis√©s\n\n√Ä bient√¥t ! üíï',
      variables: JSON.stringify(['name', 'service']),
      active: true
    },
    {
      name: 'Demande d\'avis',
      category: 'followup',
      content: 'Bonjour {name} üëã\n\nVotre avis compte ! ‚≠ê\n\nComment s\'est pass√© votre {service} ?\nPartagez votre exp√©rience :\nüëâ {review_link}\n\nMerci de votre confiance ! üíï',
      variables: JSON.stringify(['name', 'service', 'review_link']),
      active: true
    },
    {
      name: 'Promotion mensuelle',
      category: 'promotion',
      content: '‚ú® {name}, offre exclusive ! ‚ú®\n\n{promotion_text}\n\nüéÅ Code promo : {promo_code}\nüìÖ Valable jusqu\'au {expiry_date}\n\nR√©servez vite : 01 23 45 67 89\n\nüíï L\'√©quipe LAIA SKIN',
      variables: JSON.stringify(['name', 'promotion_text', 'promo_code', 'expiry_date']),
      active: true
    },
    {
      name: 'Bienvenue nouveau client',
      category: 'followup',
      content: 'Bienvenue chez LAIA SKIN {name} ! üåü\n\nNous sommes ravis de vous compter parmi nos clients.\n\nüéÅ -15% sur votre prochain soin\nüì± Gardez ce num√©ro pour vos r√©servations\nüíï Suivez-nous sur Instagram : @laiaskin\n\n√Ä tr√®s bient√¥t !',
      variables: JSON.stringify(['name']),
      active: true
    },
    {
      name: 'Confirmation r√©servation',
      category: 'reminder',
      content: '‚úÖ R√©servation confirm√©e !\n\nBonjour {name},\n\nüìÖ Date : {date}\nüïê Heure : {time}\n‚ú® Soin : {service}\nüí∞ Prix : {price}‚Ç¨\n\nüìç LAIA SKIN Institut\n23 rue Example, 75001 Paris\n\n√Ä bient√¥t ! üíï',
      variables: JSON.stringify(['name', 'date', 'time', 'service', 'price']),
      active: true
    },
    {
      name: 'Annulation RDV',
      category: 'reminder',
      content: '‚ùå Annulation confirm√©e\n\nBonjour {name},\n\nVotre rendez-vous du {date} √† {time} a bien √©t√© annul√©.\n\nPour reprendre un nouveau rendez-vous :\nüìû 01 23 45 67 89\nüí¨ R√©pondez directement √† ce message\n\n√Ä bient√¥t ! üíï',
      variables: JSON.stringify(['name', 'date', 'time']),
      active: true
    },
    {
      name: 'Relance client inactif',
      category: 'followup',
      content: 'Bonjour {name} üëã\n\nCela fait longtemps qu\'on ne s\'est pas vus ! üòä\n\nüéÅ Pour votre retour : -20% sur le soin de votre choix\nüìÖ Offre valable ce mois-ci\n\nR√©servez vite votre moment d√©tente !\n\nL\'√©quipe LAIA SKIN üíï',
      variables: JSON.stringify(['name']),
      active: true
    },
    {
      name: 'Nouveaut√© soin',
      category: 'promotion',
      content: 'üåü Nouveaut√© chez LAIA SKIN ! üåü\n\nBonjour {name},\n\nD√©couvrez notre nouveau soin : {new_service} !\n\n‚ú® {description}\nüéÅ -10% pour les premiers essais\nüìû R√©servez au 01 23 45 67 89\n\nPlus d\'infos sur notre site !',
      variables: JSON.stringify(['name', 'new_service', 'description']),
      active: true
    },
    {
      name: 'Carte cadeau',
      category: 'promotion',
      content: 'üéÅ Pensez aux cartes cadeaux ! üéÅ\n\nBonjour {name},\n\nF√™te des m√®res, anniversaire, ou juste pour faire plaisir...\n\nOffrez un moment de d√©tente avec nos cartes cadeaux :\nüíÜ‚Äç‚ôÄÔ∏è √Ä partir de 50‚Ç¨\n‚ú® Valables 1 an\nüéÄ Joliment emball√©es\n\nDisponibles √† l\'institut !',
      variables: JSON.stringify(['name']),
      active: true
    },
    {
      name: 'Conseil beaut√©',
      category: 'custom',
      content: 'üí° Conseil beaut√© du jour\n\nBonjour {name} !\n\n{beauty_tip}\n\nPour plus de conseils personnalis√©s, prenez rendez-vous avec nos expertes !\n\nüìû 01 23 45 67 89\n\nBelle journ√©e üíï',
      variables: JSON.stringify(['name', 'beauty_tip']),
      active: true
    },
    {
      name: 'Forfait √©puis√©',
      category: 'reminder',
      content: 'Bonjour {name} üëã\n\nüìä Info forfait :\nIl vous reste {remaining} s√©ance(s) sur votre forfait {package_name}.\n\nüîÑ Pensez √† renouveler pour continuer √† b√©n√©ficier de vos avantages !\n\n√Ä tr√®s bient√¥t üíï',
      variables: JSON.stringify(['name', 'remaining', 'package_name']),
      active: true
    },
    {
      name: '√âv√©nement sp√©cial',
      category: 'promotion',
      content: 'üéâ √âv√©nement sp√©cial ! üéâ\n\n{name}, vous √™tes invit√©(e) !\n\nüìÖ {event_date}\nüïê {event_time}\nüìç LAIA SKIN Institut\n\n{event_description}\n\n‚ú® Places limit√©es\nRSVP : 01 23 45 67 89\n\nOn vous attend ! üíï',
      variables: JSON.stringify(['name', 'event_date', 'event_time', 'event_description']),
      active: true
    },
    {
      name: 'M√©t√©o peau',
      category: 'custom',
      content: '‚òÄÔ∏è Alerte m√©t√©o peau ! ‚òÄÔ∏è\n\nBonjour {name},\n\n{weather_alert}\n\nüíß Conseil du jour : {skin_tip}\n\nProt√©gez votre peau !\nL\'√©quipe LAIA SKIN üíï',
      variables: JSON.stringify(['name', 'weather_alert', 'skin_tip']),
      active: true
    },
    {
      name: 'Fid√©lit√© 6√®me s√©ance',
      category: 'promotion',
      content: 'üéä F√©licitations {name} ! üéä\n\nVotre fid√©lit√© est r√©compens√©e !\n\nüéÅ Votre 6√®me s√©ance = -50% !\nüìÖ √Ä utiliser dans le mois\n\nR√©servez vite votre soin offert :\nüìû 01 23 45 67 89\n\nMerci pour votre confiance üíï',
      variables: JSON.stringify(['name']),
      active: true
    },
    {
      name: 'Parrainage',
      category: 'promotion',
      content: 'ü§ù Programme parrainage\n\nBonjour {name} !\n\nParrainez une amie et gagnez tous les deux :\nüëâ Vous : -20‚Ç¨ sur votre prochain soin\nüëâ Votre amie : -15% sur son 1er soin\n\nVotre code : {referral_code}\n\nPartagez le bonheur ! üíï',
      variables: JSON.stringify(['name', 'referral_code']),
      active: true
    },
    {
      name: 'Soldes',
      category: 'promotion',
      content: 'üõçÔ∏è LES SOLDES SONT L√Ä ! üõçÔ∏è\n\n{name}, c\'est le moment !\n\n‚ö° Jusqu\'√† -40% sur une s√©lection de soins\nüìÖ Du {start_date} au {end_date}\nüéØ Places limit√©es !\n\nR√©servez maintenant :\nüìû 01 23 45 67 89\n\nVite, √ßa part vite ! üíï',
      variables: JSON.stringify(['name', 'start_date', 'end_date']),
      active: true
    },
    {
      name: 'Horaires exceptionnels',
      category: 'reminder',
      content: 'üì¢ Info importante\n\nBonjour {name},\n\nHoraires exceptionnels :\nüìÖ {date}\nüïê {special_hours}\n\n{reason}\n\nMerci de votre compr√©hension !\nL\'√©quipe LAIA SKIN üíï',
      variables: JSON.stringify(['name', 'date', 'special_hours', 'reason']),
      active: true
    }
  ];

  // Cr√©er les templates
  for (const template of templates) {
    await prisma.whatsAppTemplate.upsert({
      where: { name: template.name },
      update: template,
      create: template
    });
  }

  console.log(`‚úÖ ${templates.length} templates WhatsApp cr√©√©s`);

  // R√©cup√©rer les IDs des templates cr√©√©s
  const createdTemplates = await prisma.whatsAppTemplate.findMany();
  const templateMap = new Map(createdTemplates.map(t => [t.name, t.id]));

  // Automatisations par d√©faut
  const automations = [
    {
      name: 'Rappel automatique 24h avant',
      trigger: 'appointment_24h',
      templateId: templateMap.get('Rappel RDV 24h') || '',
      timing: JSON.stringify({
        hoursBefore: 24,
        sendTime: '18:00'
      }),
      enabled: true
    },
    {
      name: 'Rappel automatique 48h avant',
      trigger: 'appointment_48h',
      templateId: templateMap.get('Rappel RDV 48h') || '',
      timing: JSON.stringify({
        hoursBefore: 48,
        sendTime: '10:00'
      }),
      enabled: false
    },
    {
      name: 'Message d\'anniversaire',
      trigger: 'birthday',
      templateId: templateMap.get('Anniversaire') || '',
      timing: JSON.stringify({
        sendTime: '09:00',
        dayOfYear: true
      }),
      enabled: true
    },
    {
      name: 'Suivi 24h apr√®s le soin',
      trigger: 'post_service',
      templateId: templateMap.get('Suivi post-soin') || '',
      timing: JSON.stringify({
        hoursAfter: 24,
        sendTime: '11:00'
      }),
      enabled: true
    },
    {
      name: 'Demande d\'avis 3 jours apr√®s',
      trigger: 'review_request',
      templateId: templateMap.get('Demande d\'avis') || '',
      timing: JSON.stringify({
        daysAfter: 3,
        sendTime: '15:00'
      }),
      enabled: true
    },
    {
      name: 'Confirmation imm√©diate de r√©servation',
      trigger: 'booking_confirmation',
      templateId: templateMap.get('Confirmation r√©servation') || '',
      timing: JSON.stringify({
        immediate: true
      }),
      enabled: true
    },
    {
      name: 'Message de bienvenue',
      trigger: 'new_client',
      templateId: templateMap.get('Bienvenue nouveau client') || '',
      timing: JSON.stringify({
        immediate: true
      }),
      enabled: true
    }
  ];

  // Cr√©er les automatisations
  for (const automation of automations) {
    if (automation.templateId) {
      // V√©rifier si l'automatisation existe d√©j√†
      const existing = await prisma.whatsAppAutomation.findFirst({
        where: { name: automation.name }
      });
      
      if (!existing) {
        await prisma.whatsAppAutomation.create({
          data: automation
        });
      } else {
        await prisma.whatsAppAutomation.update({
          where: { id: existing.id },
          data: automation
        });
      }
    }
  }

  console.log(`‚úÖ ${automations.length} automatisations WhatsApp cr√©√©es`);

  // Cr√©er quelques campagnes d'exemple
  const campaigns = [
    {
      name: 'Rappels du jour',
      templateId: templateMap.get('Rappel RDV 24h') || '',
      recipients: JSON.stringify([]),
      status: 'draft',
      recipientCount: 0
    },
    {
      name: 'Promo Black Friday',
      templateId: templateMap.get('Promotion mensuelle') || '',
      recipients: JSON.stringify([]),
      status: 'draft',
      recipientCount: 0
    },
    {
      name: 'Anniversaires du mois',
      templateId: templateMap.get('Anniversaire') || '',
      recipients: JSON.stringify([]),
      status: 'draft',
      recipientCount: 0
    }
  ];

  for (const campaign of campaigns) {
    if (campaign.templateId) {
      await prisma.whatsAppCampaign.create({
        data: campaign
      });
    }
  }

  console.log(`‚úÖ ${campaigns.length} campagnes WhatsApp cr√©√©es`);
  console.log('‚ú® Seed WhatsApp termin√© avec succ√®s !');
}

seedWhatsApp()
  .catch((error) => {
    console.error('‚ùå Erreur lors du seed WhatsApp:', error);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });