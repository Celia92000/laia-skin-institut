generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String            @id @default(cuid())
  email          String            @unique
  password       String
  name           String
  phone          String?
  role           String            @default("client")
  loyaltyPoints  Int               @default(0)
  totalSpent     Float             @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  adminNotes     String?
  allergies      String?
  birthDate      DateTime?
  lastVisit      DateTime?
  medicalNotes   String?
  preferences    String?
  skinType       String?
  evolutions     ClientEvolution[]
  loyaltyHistory LoyaltyHistory[]
  loyaltyProfile LoyaltyProfile?
  reservations   Reservation[]
  reviews        Review[]
  notifications  Notification[]
}

model Reservation {
  id              String    @id @default(cuid())
  userId          String
  serviceId       String?
  services        String    @default("[]") // JSON array of service IDs
  date            DateTime
  time            String
  totalPrice      Float
  status          String    @default("pending")
  source          String    @default("site")
  notes           String?
  paymentStatus   String    @default("unpaid")
  paymentDate     DateTime?
  paymentAmount   Float?
  paymentMethod   String?
  invoiceNumber   String?
  paymentNotes    String?
  reviewEmailSent    Boolean   @default(false)
  reviewWhatsAppSent Boolean   @default(false)
  reminderSent       Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id])
  service         Service?  @relation(fields: [serviceId], references: [id])
}

model Service {
  id                String        @id @default(cuid())
  slug              String        @unique @default("")
  name              String
  shortDescription  String        @default("")
  description       String
  metaTitle         String?
  metaDescription   String?
  keywords          String?
  price             Float
  launchPrice       Float?
  promoPrice        Float?
  forfaitPrice      Float?
  forfaitPromo      Float?
  duration          Int
  benefits          String? // JSON
  process           String? // JSON
  recommendations   String?
  contraindications String?
  mainImage         String?
  gallery           String? // JSON
  videoUrl          String?
  canBeOption       Boolean       @default(false)
  category          String?
  order             Int           @default(0)
  active            Boolean       @default(true)
  featured          Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  reservations      Reservation[]
}

model LoyaltyProfile {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  points                  Int       @default(0)
  tier                    String    @default("BRONZE") // BRONZE, SILVER, GOLD, PLATINUM
  individualServicesCount Int       @default(0)
  packagesCount           Int       @default(0)
  totalSpent              Float     @default(0)
  availableDiscounts      String    @default("[]") // JSON
  lastVisit               DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  user                    User      @relation(fields: [userId], references: [id])
  history                 LoyaltyHistory[]
}

model LoyaltyHistory {
  id            String         @id @default(cuid())
  userId        String
  profileId     String?
  action        String
  points        Int            @default(0)
  description   String
  reservationId String?
  createdAt     DateTime       @default(now())
  user          User           @relation(fields: [userId], references: [id])
  profile       LoyaltyProfile? @relation(fields: [profileId], references: [id])
}

model BlogPost {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  excerpt         String
  content         String
  category        String
  author          String   @default("LAIA SKIN Institut")
  readTime        String   @default("5 min")
  featured        Boolean  @default(false)
  published       Boolean  @default(true)
  mainImage       String?
  gallery         String? // JSON
  tags            String? // JSON
  metaTitle       String?
  metaDescription String?
  publishedAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model ClientEvolution {
  id             String   @id @default(cuid())
  userId         String
  sessionNumber  Int
  serviceName    String
  sessionDate    DateTime
  beforePhoto    String?
  afterPhoto     String?
  videoUrl       String?
  improvements   String? // JSON
  clientFeedback String?
  adminNotes     String?
  skinAnalysis   String? // JSON
  treatedAreas   String? // JSON
  productsUsed   String? // JSON
  hydrationLevel Int?
  elasticity     Int?
  pigmentation   Int?
  wrinkleDepth   Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id])
}

model Review {
  id            String   @id @default(cuid())
  userId        String
  reservationId String?
  serviceName   String?
  rating        Int
  comment       String
  response      String?
  approved      Boolean  @default(true)
  featured      Boolean  @default(false)
  source        String   @default("site") // site, email, whatsapp, google
  googleReview  Boolean  @default(false)
  googleUrl     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // reminder, promotion, loyalty, birthday, etc.
  title     String
  message   String
  read      Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlockedSlot {
  id        String   @id @default(cuid())
  date      DateTime
  time      String?  // Si null, toute la journée est bloquée
  allDay    Boolean  @default(false)
  reason    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([date, time])
}

model WorkingHours {
  id        String   @id @default(cuid())
  dayOfWeek Int      // 0 = Dimanche, 1 = Lundi, etc.
  startTime String   // Format: "14:00"
  endTime   String   // Format: "20:00"
  isOpen    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([dayOfWeek])
}

model Package {
  id          String   @id @default(cuid())
  name        String
  description String
  services    String // JSON array of service IDs
  price       Float
  validDays   Int      @default(90)
  maxUses     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EmailHistory {
  id           String   @id @default(cuid())
  from         String   @default("contact@laiaskininstitut.fr")
  to           String   // Email ou liste d'emails séparés par virgule
  subject      String
  content      String   // Contenu du message
  template     String?  // Template utilisé
  status       String   @default("sent") // sent, failed, pending
  direction    String   @default("outgoing") // outgoing, incoming
  campaignId   String?
  userId       String?  // Client associé
  errorMessage String?
  openedAt     DateTime?
  clickedAt    DateTime?
  createdAt    DateTime @default(now())
  campaign     EmailCampaign? @relation(fields: [campaignId], references: [id])
}

model EmailCampaign {
  id             String   @id @default(cuid())
  name           String
  subject        String
  content        String
  template       String?
  recipients     String   // JSON array des destinataires
  recipientCount Int      @default(0)
  status         String   @default("draft") // draft, scheduled, sent, cancelled
  scheduledAt    DateTime?
  sentAt         DateTime?
  openRate       Float    @default(0)
  clickRate      Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  emails         EmailHistory[]
}

model EmailAutomation {
  id          String   @id @default(cuid())
  name        String
  trigger     String   // birthday, appointment_reminder, review_request, etc.
  template    String   // EmailJS template ID
  enabled     Boolean  @default(true)
  timing      String?  // JSON avec les infos de timing
  conditions  String?  // JSON avec les conditions
  lastRun     DateTime?
  nextRun     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GoogleReview {
  id           String   @id @default(cuid())
  authorName   String
  authorPhoto  String?
  rating       Int
  comment      String
  reviewId     String   @unique // ID Google pour éviter les doublons
  publishedAt  DateTime
  replyText    String?
  replyAt      DateTime?
  helpful      Int      @default(0)
  language     String   @default("fr")
  syncedAt     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model BusinessStats {
  id                 String   @id @default(cuid())
  googleRating       Float    @default(0)
  googleReviewCount  Int      @default(0)
  internalRating     Float    @default(0)
  internalReviewCount Int     @default(0)
  lastGoogleSync     DateTime?
  googlePlaceId      String?
  googleBusinessUrl  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}