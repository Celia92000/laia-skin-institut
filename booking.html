<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©servation - LAIA SKIN INSTITUT</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            line-height: 1.8;
            color: #2c3e50;
            background: linear-gradient(135deg, #fdfbf7 0%, #f8f6f0 100%);
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(212, 181, 160, 0.2);
            color: #2c3e50;
            padding: 1.5rem 0;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-image: url('logo-laia-skin.png');
            background-size: 80px 80px;
            background-position: center center;
            background-repeat: no-repeat;
            box-shadow: 0 6px 20px rgba(212, 181, 160, 0.4);
            border: 3px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .logo h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 0;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .nav-menu a:hover {
            background: linear-gradient(135deg, #d4b5a0, #c9a084);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 181, 160, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 8rem 0 4rem;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .page-title {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #D4AF37, #B8860B, #DAA520, #CD7F32);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-title p {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            color: #5a6c7d;
            font-style: italic;
        }

        /* Service Summary */
        .service-summary {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
            border: 2px solid rgba(212, 181, 160, 0.2);
            text-align: center;
        }

        .service-name {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: #c9a084;
            margin-bottom: 0.5rem;
        }

        .service-description {
            color: #5a6c7d;
            margin-bottom: 1.5rem;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(212, 181, 160, 0.1);
            border-radius: 15px;
            margin: 1rem 0;
        }

        .price-total {
            font-size: 1.2rem;
            color: #2c3e50;
        }

        .price-deposit {
            font-size: 1.4rem;
            font-weight: bold;
            color: #c9a084;
        }

        /* Form Sections */
        .form-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
            border: 1px solid rgba(212, 181, 160, 0.2);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: #c9a084;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }

        input, select, textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(212, 181, 160, 0.3);
            border-radius: 10px;
            font-family: 'Lora', serif;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #c9a084;
            box-shadow: 0 0 0 3px rgba(201, 160, 132, 0.1);
        }

        /* Calendar */
        .calendar-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .calendar {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            border: 2px solid rgba(212, 181, 160, 0.2);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            background: none;
            border: none;
            color: #c9a084;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .calendar-nav:hover {
            background: rgba(212, 181, 160, 0.2);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .calendar-day.available {
            background: rgba(212, 181, 160, 0.1);
            color: #2c3e50;
        }

        .calendar-day.available:hover {
            background: rgba(212, 181, 160, 0.3);
        }

        .calendar-day.selected {
            background: #c9a084;
            color: white;
        }

        .calendar-day.unavailable {
            color: #ccc;
            cursor: not-allowed;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .time-slot {
            padding: 0.8rem;
            border: 2px solid rgba(212, 181, 160, 0.3);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .time-slot:hover {
            border-color: #c9a084;
            background: rgba(212, 181, 160, 0.1);
        }

        .time-slot.selected {
            background: #c9a084;
            color: white;
            border-color: #c9a084;
        }

        .time-slot.unavailable {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        /* Payment */
        .payment-summary {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,248,220,0.9));
            border: 3px solid rgba(212, 181, 160, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .payment-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
        }

        .payment-line.total {
            border-top: 2px solid rgba(212, 181, 160, 0.3);
            padding-top: 1rem;
            font-weight: bold;
            font-size: 1.2rem;
            color: #c9a084;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid rgba(212, 181, 160, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-method:hover {
            border-color: #c9a084;
            background: rgba(212, 181, 160, 0.1);
        }

        .payment-method.selected {
            border-color: #c9a084;
            background: rgba(212, 181, 160, 0.2);
        }

        .payment-method input[type="radio"] {
            margin-right: 0.5rem;
            width: auto;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-family: 'Lora', serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #D4AF37, #B8860B, #DAA520);
            color: white;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(212, 175, 55, 0.6);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #c9a084;
            color: #c9a084;
        }

        .btn-secondary:hover {
            background: #c9a084;
            color: white;
        }

        .btn-block {
            width: 100%;
            margin: 1rem 0;
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .calendar-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .page-title h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <div class="logo-circle" title="LAIA SKIN INSTITUT Logo"></div>
                <h1>LAIA SKIN INSTITUT</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="mon-institut.html">Accueil</a></li>
                <li><a href="mon-institut.html#services">Mes Prestations</a></li>
                <li><a href="mon-institut.html#contact">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Page Title -->
            <div class="page-title">
                <h1>‚ú® R√©servation</h1>
                <p id="booking-subtitle">Finalisez votre rendez-vous</p>
            </div>

            <!-- Service Summary -->
            <div class="service-summary">
                <h2 class="service-name" id="service-name">üåü Hydro'Naissance</h2>
                <p class="service-description" id="service-description">Protocole exclusif : Hydro'Cleaning + Renaissance + LED en 90 minutes</p>
                
                <div class="price-info">
                    <span class="price-total" id="price-total">Prix total : 120‚Ç¨</span>
                    <span class="price-deposit">Paiement : 100% en esp√®ces le jour J</span>
                </div>
            </div>

            <!-- Step 1: Personal Information -->
            <div class="form-section">
                <h3 class="section-title">
                    <span>üë§</span> Vos informations personnelles
                </h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Pr√©nom *</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required>
                        <small style="color: #666; font-size: 0.9em; margin-top: 0.5em; display: block;">
                            üí° Un seul compte par email - tous vos soins seront regroup√©s sur le m√™me espace client
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="phone">T√©l√©phone *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">Adresse</label>
                    <input type="text" id="address" name="address">
                </div>

                <div class="form-group">
                    <label for="notes">Notes particuli√®res (allergies, probl√®mes de peau...)</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="Informations importantes pour votre soin..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="password" id="passwordLabel">Mot de passe *</label>
                    <input type="password" id="password" name="password" required placeholder="Minimum 6 caract√®res">
                    <small id="passwordHelp" style="color: #666; font-size: 0.9rem; margin-top: 0.5rem; display: block;">
                        Ce mot de passe vous permettra d'acc√©der √† votre espace client pour suivre vos rendez-vous
                    </small>
                </div>
            </div>

            <!-- Step 2: Date & Time Selection -->
            <div class="form-section">
                <h3 class="section-title">
                    <span>üìÖ</span> Choisir votre cr√©neau
                </h3>

                <div class="calendar-container">
                    <div class="calendar">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="previousMonth()">&lt;</button>
                            <h4 id="currentMonth">Janvier 2025</h4>
                            <button class="calendar-nav" onclick="nextMonth()">&gt;</button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar days will be generated by JavaScript -->
                        </div>
                    </div>

                    <div>
                        <h4 style="margin-bottom: 1rem; color: #c9a084;">Cr√©neaux disponibles</h4>
                        <div class="time-slots" id="timeSlots">
                            <!-- Les cr√©neaux seront g√©n√©r√©s dynamiquement -->
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                            <strong>S√©lectionnez d'abord une date</strong> pour voir les cr√©neaux disponibles
                        </p>
                    </div>
                </div>
            </div>

            <!-- Step 3: Confirmation -->
            <div class="form-section">
                <h3 class="section-title">
                    <span>üí∞</span> Modalit√©s de paiement
                </h3>

                <div class="payment-summary">
                    <div class="payment-line">
                        <span id="service-label">Soin Hydro'Naissance :</span>
                        <span>120‚Ç¨</span>
                    </div>
                    <div class="payment-line">
                        <span>Dur√©e :</span>
                        <span>90 minutes</span>
                    </div>
                    <div class="payment-line total">
                        <span>Paiement le jour du rendez-vous :</span>
                        <span>120‚Ç¨ en esp√®ces</span>
                    </div>
                </div>

                <div style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 15px; margin: 1rem 0;">
                    <p style="margin: 0; font-size: 1rem; color: #2c3e50;">
                        <strong>üí∞ Paiement en esp√®ces uniquement</strong><br>
                        Le r√®glement int√©gral de 120‚Ç¨ se fera en esp√®ces le jour de votre rendez-vous. Merci de pr√©voir l'appoint.
                    </p>
                </div>

                <div style="background: rgba(255, 193, 7, 0.1); padding: 1.5rem; border-radius: 15px; margin: 1rem 0;">
                    <p style="margin: 0; font-size: 0.95rem; color: #2c3e50;">
                        <strong>üìßüì± Confirmation obligatoire</strong><br>
                        Nous vous enverrons un email et un message WhatsApp 24h avant votre rendez-vous pour confirmation. Sans r√©ponse, le cr√©neau pourra √™tre lib√©r√© pour d'autres clients.
                    </p>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <a href="eclat-supreme.html" class="btn btn-secondary">‚Üê Retour</a>
                <button class="btn btn-primary" onclick="processBooking()">
                    Confirmer ma r√©servation
                </button>
            </div>
        </div>
    </main>

    <script>
        // Configuration des services - charg√©e dynamiquement depuis la base de donn√©es
        let services = {
            // Services par d√©faut en cas d'erreur de chargement
            hydro_naissance: {
                name: "üåü Hydro'Naissance",
                description: "Protocole exclusif : Hydro'Cleaning + Renaissance + LED en 90 minutes",
                price: 120,
                duration: 90,
                preparationTime: 15,
                totalDuration: 105,
                emoji: "üåü",
                label: "Soin Hydro'Naissance"
            }
        };

        // Configuration horaires de travail
        const workingHours = {
            start: 9, // 9h00
            end: 18,  // 18h00
            slotInterval: 15 // Cr√©neaux toutes les 15 minutes
        };

        // D√©tecter le service depuis l'URL
        function getSelectedService() {
            const urlParams = new URLSearchParams(window.location.search);
            const serviceParam = urlParams.get('service') || 'hydro_naissance';
            console.log('üîç Service demand√©:', serviceParam);
            console.log('üîç Services disponibles:', Object.keys(services));
            
            // Chercher le service demand√©
            let selectedService = services[serviceParam];
            
            // Si pas trouv√©, prendre le premier service disponible
            if (!selectedService && Object.keys(services).length > 0) {
                const firstServiceKey = Object.keys(services)[0];
                selectedService = services[firstServiceKey];
                console.log('‚ö†Ô∏è Service demand√© non trouv√©, utilisation du premier:', firstServiceKey);
            }
            
            // Service par d√©faut en dernier recours
            if (!selectedService) {
                selectedService = {
                    name: "üåü Hydro'Naissance",
                    description: "Protocole exclusif : Hydro'Cleaning + Renaissance + LED en 90 minutes",
                    price: 120,
                    duration: 90,
                    preparationTime: 15,
                    totalDuration: 105,
                    emoji: "üåü",
                    label: "Soin Hydro'Naissance"
                };
                console.log('‚ö†Ô∏è Aucun service trouv√©, utilisation du service par d√©faut');
            }
            
            console.log('üéØ Service s√©lectionn√©:', selectedService);
            return selectedService;
        }

        // Mettre √† jour le contenu selon le service s√©lectionn√©
        function updateServiceContent() {
            const selectedService = getSelectedService();
            
            // Mettre √† jour les √©l√©ments du DOM
            document.getElementById('booking-subtitle').textContent = `Finalisez votre rendez-vous ${selectedService.name.replace(/[üåü‚ú®üíßüîÑüí°]/g, '').trim()}`;
            document.getElementById('service-name').textContent = selectedService.name;
            document.getElementById('service-description').textContent = selectedService.description;
            document.getElementById('price-total').textContent = `Prix total : ${selectedService.price}‚Ç¨`;
            document.getElementById('service-label').textContent = `${selectedService.label} :`;
            
            // Mettre √† jour la dur√©e dans le r√©sum√© de paiement
            const durationElement = document.querySelector('.payment-line:nth-child(2) span:last-child');
            if (durationElement) {
                durationElement.textContent = `${selectedService.duration} minutes`;
            }

            // Mettre √† jour le prix dans le r√©sum√© de paiement  
            const priceElement = document.querySelector('.payment-line:first-child span:last-child');
            if (priceElement) {
                priceElement.textContent = `${selectedService.price}‚Ç¨`;
            }
        }

        // Charger les services depuis la base de donn√©es
        async function loadServicesFromDatabase() {
            try {
                console.log('üìã Chargement des services depuis la base...');
                const response = await fetch('/api/admin/services');
                
                if (response.ok) {
                    const servicesFromDB = await response.json();
                    console.log('‚úÖ Services charg√©s:', servicesFromDB);
                    
                    // Convertir les services de la base en format utilisable
                    services = {};
                    servicesFromDB.forEach(service => {
                        const key = service.name.toLowerCase()
                            .replace(/[^a-z0-9]/g, '_')
                            .replace(/_+/g, '_')
                            .replace(/^_|_$/g, '');
                            
                        services[key] = {
                            name: service.name,
                            description: service.description,
                            price: service.price,
                            duration: service.duration,
                            preparationTime: service.preparationTime || 15,
                            totalDuration: service.totalDuration,
                            emoji: service.emoji || '‚ú®',
                            label: `Soin ${service.name.replace(/[üåü‚ú®üíßüîÑüí°]/g, '').trim()}`
                        };
                    });
                    
                    console.log('üîÑ Services convertis:', services);
                    updateServiceContent();
                } else {
                    console.warn('‚ö†Ô∏è Impossible de charger les services, utilisation des valeurs par d√©faut');
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement services:', error);
                console.log('üîß Utilisation des services par d√©faut');
            }
        }

        // Initialiser au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadServicesFromDatabase();
        });

        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let occupiedSlots = {}; // Structure: { "2025-08-14": ["14:00", "15:30"] }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthHeader = document.getElementById('currentMonth');
            
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
                "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            
            monthHeader.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay() + 1); // Start on Monday
            
            grid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            dayHeaders.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.textContent = day;
                dayElement.style.fontWeight = 'bold';
                dayElement.style.textAlign = 'center';
                dayElement.style.padding = '0.5rem';
                dayElement.style.color = '#c9a084';
                grid.appendChild(dayElement);
            });
            
            // Calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();
                
                const today = new Date();
                const isCurrentMonth = date.getMonth() === currentDate.getMonth();
                const isFutureDate = date >= today.setHours(0,0,0,0);
                const isWorkingDay = date.getDay() >= 1 && date.getDay() <= 6; // Monday to Saturday
                
                if (isCurrentMonth && isFutureDate && isWorkingDay) {
                    dayElement.classList.add('available');
                    dayElement.onclick = () => selectDate(date);
                } else {
                    dayElement.classList.add('unavailable');
                }
                
                if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
                    dayElement.classList.add('selected');
                }
                
                grid.appendChild(dayElement);
            }
        }

        function selectDate(date) {
            selectedDate = date;
            generateCalendar();
            updateTimeSlots();
        }

        // G√©n√©rer les cr√©neaux dynamiquement selon le service s√©lectionn√©
        function generateDynamicTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            const currentService = getSelectedService();
            
            if (!selectedDate) {
                timeSlotsContainer.innerHTML = '<p style="color: #666;">S√©lectionnez d\'abord une date</p>';
                return;
            }
            
            console.log(`üéØ G√©n√©ration cr√©neaux pour ${currentService.name} (${currentService.totalDuration}min total)`);
            
            const availableSlots = calculateAvailableSlots(selectedDate, currentService);
            
            timeSlotsContainer.innerHTML = '';
            
            availableSlots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.textContent = slot.display; // "09h00"
                
                if (slot.available) {
                    slotElement.classList.add('available');
                    slotElement.onclick = () => selectTime(slot.value);
                } else {
                    slotElement.classList.add('unavailable');
                    slotElement.style.opacity = '0.4';
                    slotElement.style.cursor = 'not-allowed';
                    slotElement.style.background = '#f8d7da';
                    slotElement.title = 'Cr√©neau occup√©';
                }
                
                timeSlotsContainer.appendChild(slotElement);
            });
        }

        // Calculer les cr√©neaux disponibles selon les r√©servations existantes
        function calculateAvailableSlots(date, service) {
            const slots = [];
            const dateKey = date.toISOString().split('T')[0];
            const existingSlots = occupiedSlots[dateKey] || [];
            
            console.log(`üìÖ Cr√©neaux existants pour ${dateKey}:`, existingSlots);
            
            // G√©n√©rer tous les cr√©neaux possibles de 9h √† 18h par tranches de 15min
            for (let hour = workingHours.start; hour < workingHours.end; hour++) {
                for (let minute = 0; minute < 60; minute += workingHours.slotInterval) {
                    const timeString = `${hour.toString().padStart(2, '0')}h${minute.toString().padStart(2, '0')}`;
                    const timeValue = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    
                    // V√©rifier si le cr√©neau + dur√©e du service ne d√©borde pas
                    const endTime = hour + (service.totalDuration / 60);
                    if (endTime > workingHours.end) {
                        continue; // Cr√©neau trop tard dans la journ√©e
                    }
                    
                    // V√©rifier si le cr√©neau entre en conflit avec les r√©servations existantes
                    const isConflict = checkTimeConflict(hour, minute, service.totalDuration, existingSlots);
                    
                    slots.push({
                        display: timeString,
                        value: timeValue,
                        available: !isConflict
                    });
                    
                    console.log(`üïê ${timeString}: ${isConflict ? '‚ùå OCCUP√â' : '‚úÖ LIBRE'}`);
                }
            }
            
            return slots;
        }

        // V√©rifier les conflits horaires
        function checkTimeConflict(startHour, startMinute, durationMinutes, existingSlots) {
            const startTime = startHour * 60 + startMinute; // Convertir en minutes
            const endTime = startTime + durationMinutes;
            
            return existingSlots.some(existingSlot => {
                // Convertir le format "15h30" en minutes
                const [hourStr, minuteStr] = existingSlot.split('h');
                const existingStart = parseInt(hourStr) * 60 + parseInt(minuteStr);
                
                // Supposer une dur√©e par d√©faut pour les cr√©neaux existants (on r√©cup√©rera √ßa du serveur plus tard)
                const existingDuration = 90; // TODO: r√©cup√©rer la vraie dur√©e depuis la base
                const existingEnd = existingStart + existingDuration;
                
                // Conflit si les cr√©neaux se chevauchent
                const hasConflict = (startTime < existingEnd && endTime > existingStart);
                
                if (hasConflict) {
                    console.log(`‚ö†Ô∏è Conflit d√©tect√©: nouveau ${startTime}-${endTime}min vs existant ${existingStart}-${existingEnd}min`);
                }
                
                return hasConflict;
            });
        }

        function updateTimeSlots() {
            generateDynamicTimeSlots();
            selectedTime = null;
        }

        function selectTime(time) {
            if (!selectedDate) {
                alert('Veuillez d\'abord s√©lectionner une date');
                return;
            }
            
            // V√©rifier si le cr√©neau est occup√©
            if (isSlotOccupied(selectedDate, time)) {
                showBookingNotification('‚ö†Ô∏è Ce cr√©neau est d√©j√† occup√©, veuillez en choisir un autre', 'warning');
                return;
            }
            
            selectedTime = time;
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        function processBooking() {
            // Validate form
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            
            if (!firstName || !lastName || !email || !phone || !password) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            if (password.length < 6) {
                alert('Le mot de passe doit contenir au moins 6 caract√®res');
                return;
            }
            
            if (!selectedDate || !selectedTime) {
                alert('Veuillez s√©lectionner une date et un cr√©neau');
                return;
            }
            
            // Get current service information
            const currentService = getSelectedService();
            
            // DEBUG: V√©rifier les donn√©es avant envoi
            console.log('üêû DEBUG - Donn√©es du formulaire:');
            console.log('firstName:', firstName);
            console.log('lastName:', lastName);
            console.log('email:', email);
            console.log('phone:', phone);
            console.log('password:', password);
            console.log('selectedDate:', selectedDate);
            console.log('selectedTime:', selectedTime);
            
            // V√©rifier que la date et l'heure sont s√©lectionn√©es
            if (!selectedDate) {
                alert('Veuillez s√©lectionner une date pour votre rendez-vous');
                return;
            }
            
            if (!selectedTime) {
                alert('Veuillez s√©lectionner un cr√©neau horaire');
                return;
            }
            
            // Prepare booking data
            const bookingData = {
                service: currentService.name,
                serviceType: new URLSearchParams(window.location.search).get('service') || 'hydro_naissance',
                firstName,
                lastName,
                email,
                phone,
                password,
                date: selectedDate.toLocaleDateString('fr-FR'),
                time: selectedTime,
                amount: currentService.price,
                paymentMethod: 'cash',
                origine: 'Site internet',
                source: 'Booking Page',
                notes: document.getElementById('notes').value || '',
                address: document.getElementById('address').value || ''
            };
            
            console.log('üêû DEBUG - bookingData complet:', bookingData);
            
            // Process booking without payment
            processCashBooking(bookingData);
        }
        
        async function processCashBooking(bookingData) {
            try {
                // Disable the button to prevent double submission
                const submitButton = document.querySelector('.btn-primary');
                submitButton.disabled = true;
                submitButton.textContent = 'Cr√©ation en cours...';
                
                // Create booking and user account
                const response = await fetch('/api/create-cash-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bookingData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Erreur lors de la cr√©ation de la r√©servation');
                }
                
                const result = await response.json();
                
                // Show success message
                alert(`‚úÖ R√©servation confirm√©e !\n\nService: ${bookingData.service}\nClient: ${bookingData.firstName} ${bookingData.lastName}\nDate: ${bookingData.date} √† ${bookingData.time}\nPaiement: 120‚Ç¨ en esp√®ces le jour J\n\nVous allez recevoir un email de confirmation avec vos identifiants de connexion.`);
                
                // Redirect to success page
                window.location.href = '/booking-success.html?booking_id=' + result.bookingId;
                
            } catch (error) {
                console.error('Erreur cr√©ation r√©servation:', error);
                alert('Erreur lors de la r√©servation: ' + error.message);
                
                // Re-enable the button
                const submitButton = document.querySelector('.btn-primary');
                submitButton.disabled = false;
                submitButton.textContent = 'Confirmer ma r√©servation';
            }
        }

        // === SYNCHRONISATION TEMPS R√âEL BOOKING ===
        
        // Variables pour la synchronisation
        let bookingOccupiedSlots = {};
        let bookingLastUpdateTime = 0;

        // Charger les cr√©neaux occup√©s avec synchronisation
        async function loadBookingOccupiedSlots(forceUpdate = false) {
            try {
                const url = `/api/appointments/occupied-slots?timestamp=${Date.now()}`;
                console.log('üìÖ [Booking] Chargement cr√©neaux occup√©s...');
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    const newSlots = data.occupiedSlots || [];
                    
                    // Convertir en format utilisable
                    const newOccupiedSlots = {};
                    newSlots.forEach(slot => {
                        const date = new Date(slot.datetime);
                        const dateKey = date.toISOString().split('T')[0];
                        const timeKey = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        
                        if (!newOccupiedSlots[dateKey]) {
                            newOccupiedSlots[dateKey] = [];
                        }
                        newOccupiedSlots[dateKey].push(timeKey);
                    });
                    
                    // V√©rifier s'il y a des changements
                    const hasChanges = JSON.stringify(bookingOccupiedSlots) !== JSON.stringify(newOccupiedSlots);
                    
                    if (hasChanges || forceUpdate) {
                        const oldCount = Object.keys(bookingOccupiedSlots).reduce((sum, date) => sum + bookingOccupiedSlots[date].length, 0);
                        const newCount = Object.keys(newOccupiedSlots).reduce((sum, date) => sum + newOccupiedSlots[date].length, 0);
                        
                        bookingOccupiedSlots = newOccupiedSlots;
                        bookingLastUpdateTime = Date.now();
                        
                        console.log('üîÑ [Booking] Cr√©neaux mis √† jour:', newCount, 'cr√©neaux occup√©s');
                        
                        // Notification si nouveaux cr√©neaux occup√©s
                        if (newCount > oldCount && oldCount > 0) {
                            const newSlots = newCount - oldCount;
                            showBookingNotification(`‚ö†Ô∏è ${newSlots} nouveau${newSlots > 1 ? 'x' : ''} cr√©neau${newSlots > 1 ? 'x' : ''} occup√©${newSlots > 1 ? 's' : ''}!`, 'warning');
                        }
                        
                        // Mettre √† jour l'affichage du calendrier
                        updateBookingCalendar();
                        
                        // Notifier les autres pages
                        localStorage.setItem('laia-booking-update', bookingLastUpdateTime.toString());
                    }
                } else {
                    console.warn('‚ö†Ô∏è [Booking] Impossible de charger les cr√©neaux occup√©s');
                }
            } catch (error) {
                console.error('‚ùå [Booking] Erreur chargement cr√©neaux:', error);
            }
        }

        // Mettre √† jour l'affichage du calendrier booking
        function updateBookingCalendar() {
            generateCalendar();
            updateTimeSlots();
        }

        // V√©rifier si un cr√©neau est occup√©
        // Charger les cr√©neaux occup√©s depuis l'API
        async function loadOccupiedSlots() {
            try {
                const response = await fetch('/api/appointments/occupied-slots');
                if (response.ok) {
                    const data = await response.json();
                    occupiedSlots = {}; // R√©initialiser
                    
                    data.occupiedSlots.forEach(slot => {
                        const date = new Date(slot.datetime);
                        const dateKey = date.toISOString().split('T')[0]; // Format: 2025-08-14
                        const timeKey = date.getHours().toString().padStart(2, '0') + 'h' + date.getMinutes().toString().padStart(2, '0'); // Format: 15h30
                        
                        if (!occupiedSlots[dateKey]) {
                            occupiedSlots[dateKey] = [];
                        }
                        occupiedSlots[dateKey].push(timeKey);
                    });
                    
                    console.log('üîí Cr√©neaux occup√©s charg√©s:', occupiedSlots);
                    
                    // Debug: afficher les cr√©neaux du 14 ao√ªt
                    if (occupiedSlots['2025-08-14']) {
                        console.log('üìÖ Cr√©neaux occup√©s le 14/08/2025:', occupiedSlots['2025-08-14']);
                    }
                    
                    // Mettre √† jour l'affichage si une date est s√©lectionn√©e
                    if (selectedDate) {
                        updateTimeSlots();
                    }
                } else {
                    console.warn('‚ö†Ô∏è Impossible de charger les cr√©neaux occup√©s');
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement cr√©neaux occup√©s:', error);
            }
        }

        function isSlotOccupied(date, time) {
            const dateKey = date.toISOString().split('T')[0];
            const isOccupied = occupiedSlots[dateKey] && occupiedSlots[dateKey].includes(time);
            console.log(`üîç V√©rification cr√©neau ${dateKey} ${time}:`, isOccupied, 'Cr√©neaux occup√©s:', occupiedSlots[dateKey]);
            return isOccupied;
        }

        // Fonction pour d√©marrer la synchronisation temps r√©el
        function startBookingRealtimeSync() {
            // Polling toutes les 3 secondes
            setInterval(() => {
                loadBookingOccupiedSlots();
            }, 3000);
            
            // √âcouter les changements depuis les autres pages
            window.addEventListener('storage', (e) => {
                if (e.key === 'laia-calendar-update' || e.key === 'laia-new-booking') {
                    console.log('üîî [Booking] Nouvelle r√©servation d√©tect√©e');
                    setTimeout(() => loadBookingOccupiedSlots(true), 200);
                }
            });
            
            // Actualiser quand l'utilisateur revient sur l'onglet
            window.addEventListener('focus', () => {
                console.log('üëÅÔ∏è [Booking] Focus - actualisation');
                loadBookingOccupiedSlots(true);
            });
            
            console.log('‚ö° [Booking] Synchronisation temps r√©el activ√©e');
        }

        // Fonction pour afficher les notifications booking
        function showBookingNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                font-size: 1rem;
                z-index: 10001;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
                transform: translateX(400px);
                transition: all 0.4s ease;
                max-width: 350px;
                border-left: 4px solid;
            `;
            
            const styles = {
                'success': 'background: rgba(40, 167, 69, 0.95); border-color: #28a745;',
                'warning': 'background: rgba(255, 193, 7, 0.95); border-color: #ffc107; color: #212529;',
                'error': 'background: rgba(220, 53, 69, 0.95); border-color: #dc3545;',
                'info': 'background: rgba(23, 162, 184, 0.95); border-color: #17a2b8;'
            };
            
            notification.style.cssText += styles[type] || styles.info;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                           style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.3rem; margin-left: auto;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => notification.remove(), 400);
            }, 4000);
        }

        // Fonction pour v√©rifier si un email existe d√©j√†
        async function checkExistingEmail(email) {
            try {
                const response = await fetch(`${window.location.origin}/api/auth/check-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email.toLowerCase() })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.exists;
                }
                return false;
            } catch (error) {
                console.error('Erreur v√©rification email:', error);
                return false;
            }
        }
        
        // Fonction pour adapter l'interface selon le type de client
        function updatePasswordInterface(isExistingClient) {
            const passwordLabel = document.getElementById('passwordLabel');
            const passwordHelp = document.getElementById('passwordHelp');
            
            if (isExistingClient) {
                passwordLabel.textContent = 'Votre mot de passe *';
                passwordHelp.textContent = 'Saisissez le mot de passe de votre compte existant';
                passwordHelp.style.color = '#c9a084';
            } else {
                passwordLabel.textContent = 'Cr√©er un mot de passe *';
                passwordHelp.textContent = 'Ce mot de passe vous permettra d\'acc√©der √† votre espace client pour suivre vos rendez-vous';
                passwordHelp.style.color = '#666';
            }
        }

        // Initialize calendar on page load - combin√© avec le chargement des services
        document.addEventListener('DOMContentLoaded', function() {
            // Charger d'abord les services, puis initialiser le reste
            loadServicesFromDatabase().then(() => {
                generateCalendar();
                
                // üöÄ CHARGER LES CR√âNEAUX OCCUP√âS
                loadOccupiedSlots();
                
                // Rafra√Æchir les cr√©neaux toutes les 30 secondes
                setInterval(loadOccupiedSlots, 30000);
                
                // Ajouter un listener sur le champ email pour d√©tecter les clients existants
                const emailField = document.getElementById('email');
                let emailCheckTimeout;
                
                emailField.addEventListener('input', function() {
                    clearTimeout(emailCheckTimeout);
                    const email = this.value.trim();
                    
                    if (email && email.includes('@')) {
                        emailCheckTimeout = setTimeout(async () => {
                            const isExisting = await checkExistingEmail(email);
                            updatePasswordInterface(isExisting);
                            
                            if (isExisting) {
                                showBookingNotification('üí° Compte existant d√©tect√© - utilisez votre mot de passe actuel', 'info');
                            }
                        }, 500);
                    } else {
                        // Revenir √† l'interface par d√©faut si l'email n'est pas valide
                        updatePasswordInterface(false);
                    }
                });
                
                console.log('üìÖ Booking initialis√© avec syst√®me de cr√©neaux occup√©s et d√©tection de clients existants');
            });
        });
    </script>

<!-- Syst√®me de synchronisation centralis√© -->
<script src="/sync-system.js"></script>
<script>
    // Initialisation sp√©cifique √† la page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ Syst√®me de synchronisation charg√©');
        
        // Enregistrer un callback pour les mises √† jour
        if (window.syncManager) {
            window.syncManager.onUpdate((booking, action) => {
                console.log('üìä Mise √† jour re√ßue:', action, booking);
                
                // Rafra√Æchir les √©l√©ments de la page si n√©cessaire
                if (typeof refreshPageElements === 'function') {
                    refreshPageElements();
                }
                
                // Pour l'admin dashboard
                if (typeof loadAdminReservations === 'function') {
                    loadAdminReservations(true);
                }
                
                // Pour le calendrier
                if (typeof updateCalendar === 'function') {
                    updateCalendar();
                }
                
                // Pour les tableaux
                if (typeof updateReservationsTable === 'function') {
                    updateReservationsTable();
                }
            });
        }
    });
</script>

<script>
    // Adapter les formulaires de r√©servation existants
    document.addEventListener('DOMContentLoaded', function() {
        // Intercepter tous les formulaires de r√©servation
        const bookingForms = document.querySelectorAll('form[id*="booking"], form[id*="reservation"], .booking-form, .reservation-form');
        
        bookingForms.forEach(form => {
            console.log('üìù Formulaire de r√©servation trouv√©:', form.id || form.className);
            
            // Remplacer le gestionnaire de soumission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('üöÄ Soumission intercept√©e par SyncManager');
                
                // Extraire les donn√©es du formulaire
                const formData = new FormData(form);
                const bookingData = {};
                
                for (let [key, value] of formData.entries()) {
                    bookingData[key] = value;
                }
                
                // D√©terminer la source
                const source = window.location.pathname.includes('admin') ? 'admin' : 
                              window.location.pathname.includes('espace-client') ? 'client-space' :
                              window.location.pathname.includes('prestations') ? 'prestations' :
                              'booking-page';
                
                try {
                    // Utiliser SyncManager pour cr√©er la r√©servation
                    const result = await window.syncManager.createBooking(bookingData, source);
                    
                    if (result) {
                        // Afficher un message de succ√®s
                        if (typeof showSuccessMessage === 'function') {
                            showSuccessMessage('R√©servation confirm√©e!');
                        } else {
                            alert('‚úÖ Votre r√©servation a √©t√© confirm√©e!');
                        }
                        
                        // R√©initialiser le formulaire
                        form.reset();
                        
                        // Rediriger si n√©cessaire
                        if (bookingData.redirect) {
                            setTimeout(() => {
                                window.location.href = bookingData.redirect;
                            }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur r√©servation:', error);
                    alert('Une erreur est survenue. Veuillez r√©essayer.');
                }
                
                return false;
            });
        });
    });
</script>

<!-- Syst√®me de synchronisation des r√©servations -->
<script src="sync-reservations.js"></script>

<!-- Syst√®me de cr√©neaux intelligents avec blocage en temps r√©el -->
<script src="smart-booking-slots.js"></script>

</body>
</html>